<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg" href="images/d20-black-whitebg.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Babylonica&family=Bilbo+Swash+Caps&family=Caveat:wght@400;500;600;700&family=Comforter&family=Condiment&family=Dawning+of+a+New+Day&family=East+Sea+Dokdo&family=Fuggles&family=Grape+Nuts&family=Homemade+Apple&family=Inspiration&family=Julee&family=Just+Me+Again+Down+Here&family=Kolker+Brush&family=La+Belle+Aurore&family=Liu+Jian+Mao+Cao&family=Long+Can&family=Nanum+Brush+Script&family=Nothing+You+Could+Do&family=Oooh+Baby&family=Over+the+Rainbow&family=Permanent+Marker&family=Qwitcher+Grypen:wght@400;700&family=Reenie+Beanie&family=Rock+Salt&family=Ruthie&family=Sassy+Frass&family=Sedgwick+Ave&family=Shalimar&family=Smooch&family=Splash&family=Square+Peg&family=Swanky+and+Moo+Moo&family=Vujahday+Script&family=Waiting+for+the+Sunrise&family=Walter+Turncoat&family=Whisper&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/d1a29cf881.js" crossorigin="anonymous"></script>
    <title>Initiative Touch</title>
    <style>
        :root {
            --brightness-level: 1;
            --body-color: #777;
            --body-bg-images: url('https://baldursgate3.game/png/menu-shadow-right-mobile.png'), url('https://baldursgate3.game/png/menu-shadow-left-mobile.png'), url(https://baldursgate3.game/masks/smoke.jpg); /*url(https://foundryvtt.com/static/assets/layout/home-background.webp);*/
            --body-bg-image-positions: top right, top left, center;
            --body-bg-image-sizes: auto, auto, cover;
            --main-text-color: #999;
            --main-text-color-alt: #777;
            --div-bg-color: transparent; /*#222;*/
            --div-bg-image: url('images/slate-bg.png');
            --div-bg-image-2: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAABGBAMAAACDAP+3AAAAGFBMVEUfHx8eHh4dHR0bGxshISEiIiIlJSUjIyM9IpsJAAAFjUlEQVR4AT3UuZLcOBaF4QuI2XJxboIhF/eQFe1WovoBAAqccpkaZpc5+4yrXa8/RGpx/lrIXPjFCYjTp9z8REqF4VYNWB3Av3zQJ6b6xBwlKB/9kRkCjXVwGH3ziK5UcjFHVkmgY6osiBsGDFfseqq2ZbTz7E00qBDpzOxnD7ToABeros1vM6MX0rBQaG1ith1A/HJkvkHxsPGJ82dP8vVCyWmbyPTaAfGzg40bgIdrv2f3pBVPycUcufx+BSUUWDuCZi6zBqdM50ElKYPODqtLDjc31rBb9CZ59lbN/JScuMxHLUBcGiy6QRH9zpwgZGhRj8qSydPVgNNVgbWqYX3HbM9K2rqTnKVmsmwKWzc1ffEd20+Zq3Ji65kl6TSjALNvzmJt4Pi2f1etytGJmy5erLAgbNY4bjykC3YCLIS3nSZMKgwRsBarWgjdeVzIEDzpTkoOUArTF4WFXYHwxY585sT0nmTYMxmXfs8fzwswfnam8TMU49bvqSRnyRPnqlno4tVQQiH2A9Za8tNTfXQ0lxbSxUaZna0uLlj9Q0XzD96CpsOZUftolINKBWJpAOoAJC0T6QqZnOtfvcfJFcDrD4Cuy5Hng316XrqzJ204HynyHwWed6i+XGF40Uw2T7Lc71HyssngEOrgONfBY7wvW0UZdVAma5xmSNjRp3xkvKJkW6aSg7PK4K0+mbKqYB0WYBgWwxCXiS74zBCVlEFpYQDEwjcA1qccb5yO6ZL8ozt/h3wHSCdWzLuqxU2ZZ9ev9MvRMbMvV9BQgN0qrFjlkzPQanI9nuaGCokVK2LV1Y2egyY1aFQGxjM9I7RBBAgyGEJtpKHP0lUySSeWCpyKHMT2pmM/vyP55u2Rw5lcSeabAfgiG5TPDX3uP3QvcoSipJXQByUCjS4C8VXqxEEZOJxzmJoyogFNJBRsCJs2XmoWWrWFqTsnbwtSn43gNFTTob9/SEpaPJNhUBKDGoZGCMINxvBv8vuKbb//lg/sK0wfPgBica/QsSk5F3KK4Ui6Yw+uv4+DWEOFbhdPOnbY5PLFpzrZMhakeqomY0Vz0TO+elQGTWdCk1IYFAOaoZg0IJQhT+YreXF+yia+O1cgtGufjXxQw28f85RPXfd15zv13ABoD15kB7FKJ/7pbHKP6+9TgNgkVj68NeV8Tp24f7OOndCgJzR3RNJBPNFReCmstMVqvjjzBoeK4GOFoBN32CPxu+4TwwBDa4DJTe/OU9c9ku7EGyfOVxh+fw9g/AATxPqKTEXJKEdCIBkB4iBUlO6MjUrWi6M5Kz31YAqFsYaCeB0KJC5d1+foo3LQWSfRaDrwdAQrMEC27yDZXJf7TlOJ2Bczr1di3OWvZB6XrvvqPuWJPDk9dAHgm7LvuZJTEdKqO3J3XgostArEnvkqgUznx3PX7cSzz1FXZyvakTA4XVVMbCPFPK1cFj66S0WoqQI1XG2uoU7CMPquO2VaUDJFQMdVgXKD2bpz6ufzzxXbxszHQ9fGO/F7A998yBQG6cShE+P+Pk7t1FwfF1QHN1Eui1VapRxCdj8tCtI1bog1Fo011Sx9u3o6c9bufI6wAT26Av9xJ+WWpTKbbBPp3K/1LbC4Vuhv396RCbJw4untjxVPndj+dIB9dVD8z2dylZ+6vMeJwbYChHJkvHV2J3fdHsJPASeHhrXq6QheXu1nBhUr5u6ryT0I13BFKD01ViZ/n3oaziRG7c6Ayg7g1LPeztNdT36ueMqcN4XGv3finjfv+7I/kMJ4d046MUanOA1QtMH1kLlfFasm99NiutSw63yNDeH4zeL1Uu8XKHNfcThPSSNwchGMbgUETScwkCcK77pH2jsgrAssvVyB8FLJ7GrmwyD8eVqsHoY/FwIv9T7lPu9+Yf8/9+w4nS1ma78AAAAASUVORK5CYII=);
            --main-bg-image-mask: url('images/bottom-splotch-mask.png');
            --main-text-shadow: -0.05em -0.05em rgba(0,0,0,0.5);
            --div-border-color: none; /*black;*/
            --playerlist-bg-img: none; /*url('images/brown-parchment.jpg');*/ /*url('https://baldursgate3.game/masks/box-background.jpg');*/ /*url('https://baldursgate3.game/masks/box-background.jpg');*/
            --playerlist-shadow: none; /*0 0 30px 0px rgba(150,120,100,0.4);*/
            --button-font: 'East Sea Dokdo';
            --button-text-color: rgba(255,255,255,0.4);
            --button-bg-color: rgb(114 65 32 / 85%); /*rgb(99 53 22 / 85%);*/ /*rgba(255,100,0,0.15);*/
            --button-bg-color--hover: rgb(143 77 30 / 85%); /*rgb(110 58 21 / 85%);*/ /*rgba(200,40,0,0.2);*/
            --button-border-color: none; /*rgba(255,255,255,0.1);*/ /*rgba(0,0,0,0.7)*/
            --button-outline-focus: rgba(255,100,0,0.5);
            --mic-color: #8c7f76;
            --input-bg-color: rgba(0,0,0,0.8);
            --input-placeholder-color: #555;
            --highlighted-color: rgba(119,153,225,0.25);
            --highlighted-text-color: #bbb;
            --grungy-mask1: url('images/grungy-mask4.png');
            --grungy-mask2: url('images/grungy-mask3.png');
            --grungy-mask3: url('images/grungy-mask2.png');
            --grungy-mask4: url('images/grungy-mask1.png');
            --grungy-mask5: url('images/grungy-mask5.png');
        }

        /* Downloaded fonts */
        @font-face { font-family: "Baron Kuffner"; font-style: normal; font-weight: 400; src: local("Baron Kuffner"), url("fonts/Baron Kuffner.otf") format("opentype"); }
        @font-face { font-family: "Broken Crush"; font-style: normal; font-weight: 400; src: local("Broken Crush"), url("fonts/Broken Crush.otf") format("opentype"); }
        @font-face { font-family: "Creatinin-pro"; font-style: normal; font-weight: 400; src: local("Creatinin-pro"), url("fonts/creatinin-pro.otf") format("opentype"); }
        @font-face { font-family: "Do You Want To Be My Inverted Interrobang"; font-style: normal; font-weight: 400; src: local("Do You Want To Be My Inverted Interrobang"), url("fonts/Do you want to be my Inverted Interrobang.otf") format("opentype"); }
        @font-face { font-family: "Dracufrankenwolfbb"; font-style: normal; font-weight: 400; src: local("Dracufrankenwolfbb"), url("fonts/DracuFrankenWolfBB.otf") format("opentype"); }
        @font-face { font-family: "Eordeoghlakat"; font-style: normal; font-weight: 400; src: local("Eordeoghlakat"), url("fonts/Eordeoghlakat.ttf") format("truetype"); }
        @font-face { font-family: "Fibyngerowa"; font-style: normal; font-weight: 400; src: local("Fibyngerowa"), url("fonts/Fibyngerowa.otf") format("opentype"); }
        @font-face { font-family: "Grenhil"; font-style: normal; font-weight: 400; src: local("Grenhil"), url("fonts/Grenhil.otf") format("opentype"); }
        @font-face { font-family: "Ickyticketmono"; font-style: normal; font-weight: 400; src: local("Ickyticketmono"), url("fonts/IckyTicketMono.ttf") format("truetype"); }
        @font-face { font-family: "Kgbythegraceofgod"; font-style: normal; font-weight: 400; src: local("Kgbythegraceofgod"), url("fonts/KGBytheGraceofGod.ttf") format("truetype"); }
        @font-face { font-family: "Lincons"; font-style: normal; font-weight: 400; src: local("Lincons"), url("fonts/LINCONS.otf") format("opentype"); }
        @font-face { font-family: "Lugosi"; font-style: normal; font-weight: 400; src: local("Lugosi"), url("fonts/Lugosi.ttf") format("truetype"); }
        @font-face { font-family: "Malinsha Rough"; font-style: normal; font-weight: 400; src: local("Malinsha Rough"), url("fonts/Malinsha Rough.otf") format("opentype"); }
        @font-face { font-family: "Mystic Forest"; font-style: normal; font-weight: 400; src: local("Mystic Forest"), url("fonts/Mystic Forest.otf") format("opentype"); }
        @font-face { font-family: "Raventame"; font-style: normal; font-weight: 400; src: local("Raventame"), url("fonts/Raventame.otf") format("opentype"); }
        @font-face { font-family: "Unionagrochem"; font-style: normal; font-weight: 400; src: local("Unionagrochem"), url("fonts/unionagrochem.ttf") format("truetype"); }
        @font-face { font-family: "Vtks Distress"; font-style: normal; font-weight: 400; src: local("Vtks Distress"), url("fonts/vtks distress.ttf") format("truetype"); }


        html {
            min-height: 100%;
            min-height: -moz-available;          /* WebKit-based browsers will ignore this. */
            min-height: -webkit-fill-available;  /* Mozilla-based browsers will ignore this. */
            min-height: fill-available;
        }
        body {
            margin: 8px;
            line-height: 1.2; /* but some fonts override this */
            background: black  no-repeat;
            background-image: var(--body-bg-images);
            background-position: var(--body-bg-image-positions);
            background-size: var(--body-bg-image-sizes);
            touch-action: manipulation;
            filter: brightness(var(--brightness-level));
        }
        p,
        li {
            font-size: 2em;
            text-shadow: var(--main-text-shadow);
            text-rendering: optimizelegibility;
            color: var(--main-text-color);
            -webkit-mask-image: var(--grungy-mask3);
            mask-image: var(--grungy-mask3);
            -webkit-mask-size: cover;
            mask-size: cover;
        }
        label {
            font-size: 1.5em;
        }
        input {
            margin: 0;
            outline: none !important;
            padding: 0 1.25em;
            border: none;
            border-radius: 15px;
            box-sizing: border-box;
            width: calc(100% - 4em);
            font-family: inherit;
            font-size: 0.5em;
            background: var(--input-bg-color);
            color: var(--main-text-color);
            -webkit-mask-image: var(--grungy-mask1);
            mask-image: var(--grungy-mask1);
            -webkit-mask-size: cover;
            mask-size: cover;
        }
        /* Hide number incr/decr buttons in  most modern browsers */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Hide number incr/decr buttons in Firefox */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        button {
            margin: 5px;
            padding: 0.1em 1.5em;
            border: 2px solid var(--button-border-color);
            border-radius: 10px;
            font-size: 2rem;
            font-family: var(--button-font);
            color: var(--button-text-color);
            background: var(--button-bg-color);
            -webkit-mask-image: var(--grungy-mask1);
            mask-image: var(--grungy-mask1);
            -webkit-mask-size: cover;
            mask-size: cover;
            -webkit-mask-position: bottom;
            mask-position: bottom;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        button:hover,
        button:focus {
            background-color: var(--button-bg-color--hover);
        }
        button:focus-visible {
            outline: 2px var(--button-outline-focus) solid;
        }
        button[disabled] {
            opacity: 0.25;
            pointer-events: none;
        }
        .button-group {
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }
        .button-group button {
            margin: 0;
            padding: 0.2em 0.5em 0.25em;
            font-size: 1.5em;
        }
        .button-group-number-bump {
            justify-content: center;
        }
        .input-number-bump {
            margin: 0 0.5em;
            padding: 0;
            width: 4em;
            height: 2.25em;
            text-align: center;
            font-size: 1em;
        }
        select {
            padding: 0 1em;
            outline: none;
            border: none;
            border-radius: 0.5em;
            height: 2.5em;
            font-family: inherit;
            font-size: 1em;
            color: var(--main-text-color);
            background: var(--input-bg-color);
            -webkit-mask-image: var(--grungy-mask1), var(--grungy-mask4);
            mask-image: var(--grungy-mask1), var(--grungy-mask4);
            -webkit-mask-size: cover, contain;
            mask-size: cover, contain;
            -webkit-mask-position: left, right;
            mask-position: left, right;
        }
        .select::-ms-expand {
            /* Hide the default arrow of the select box */
            display: none;
        }
        
        /* Nav bar */
        .header-menu {
            display: flex;
            justify-content: flex-end;
            height: 50px;
        }
        .toggle-settings-menu {
            display: flex;
            align-items: center;
            padding: 0.25em;
            background-color: #421;
        }
        .toggle-settings-menu:not(.back) .back-ui {
            display: none;
        }
        .toggle-settings-menu.back .no-back-ui {
            display: none;
        }

        /* Main wrapper */
        .main,
        .settings-menu {
            position: relative;
            display: flex;
            flex-flow: column;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            margin: 0 auto;
            padding: 32px 5vw 250px;
            border: 1px solid var(--div-border-color);
            box-shadow: 0px 0px 32px black;
            background: var(--div-bg-color) var(--div-bg-image) no-repeat scroll left top;
            background-size: cover;
            -webkit-mask-image: var(--main-bg-image-mask); /* For Safari */
            mask-image: var(--main-bg-image-mask);
            -webkit-mask-size: cover;
            mask-size: cover;
            -webkit-mask-position: right bottom;
            mask-position: right bottom;
            width: 90vw;
            min-height: 100%;
            min-height: -moz-available;          /* WebKit-based browsers will ignore this. */
            min-height: -webkit-fill-available;  /* Mozilla-based browsers will ignore this. */
            min-height: fill-available;

            max-width: 600px;
            color: var(--main-text-color);
        }

        /* Settings menu */
        .settings-menu-group {
            margin: 1em auto 1em 0;
            padding-left: 0.5em;
            font-size: 1.25em;
        }
        .settings-input {
            margin: 0.5em 0 0;
        }

        /* Close (X) button */
        .clear-all {
            position: absolute;
            top: 0.5em;
            right: 0.5em;
            padding: 0.5em 0.25em 0.25em;
            width: auto;
            line-height: 0.5;
            color: var(--main-text-color-alt);
            text-shadow: var(--main-text-shadow);
            -webkit-mask-image: var(--grungy-mask1);
            mask-image: var(--grungy-mask1);
            background: none;
            appearance: none;
        }
        /* microphone permission messaging */
        .pre-microphone-msg,
        .post-microphone-msg {
            position: absolute;
            margin-top: 0.5em;
            width: 90%;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            user-select: none;
            transition: opacity 1s;
        }
        .pre-microphone-msg.show,
        .post-microphone-msg.show {
            opacity: 1;
        }
        /* microphone button */
        #startDictation {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 3em auto 0;
            border-radius:50%;
            font-size: 15vw;
            width: 2em;
            min-height: 2em;
            color: var(--mic-color);
            background-color:var(--button-bg-color);
            -webkit-mask-image: var(--grungy-mask1);
            mask-image: var(--grungy-mask1);
            -webkit-mask-size: initial;
            mask-size: initial;
            -webkit-mask-position: center;
            mask-position: center;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.15s, width 0.5s, min-height 0.5s, font-size 0.5s;
        }

        /* Pseudo-element for the hover effect */
        #startDictation::before {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            border-radius: 50%;
            width: 0;
            aspect-ratio: 1;
            background: radial-gradient(white, rgb(0 66 152));
            box-shadow: 0 0 15px -3px rgba(255,255,255,1);
            transform: translate(-50%, -50%);
            transition: width 0.2s;
            z-index: -1;
        }

        #startDictation:active::before {
            width: 100%;
        }
        #startDictation:hover,
        #startDictation:focus {
            background-color: var(--button-bg-color--hover);
        }
        #startDictation:focus-visible {
            outline: 2px var(--button-outline-focus) solid;
        }
        .players-listed #startDictation {
            margin: 0 auto;
            font-size: 9vw;
        }
        @media (min-width: 768px) {
            #startDictation {
                font-size: 100px;
            }
            .players-listed #startDictation {
                font-size: 60px;
            }
        }
        input.speech-input {
            display: block;
            opacity: 0.2;
            background: #111;
            color: #ccc;
            font-size: 2em;
            transition: font-size 0.15s;

            /* hide for now */
            opacity: 0 !important;
            height: 0;
            /* end hide */
        }
        input.speech-input:focus {
            /* only show when dictating for now */
            opacity: 1 !important;
            height: auto;
        }
        input.speech-input:last-of-type,
        input.speech-input:focus {
            opacity: 1;
        }
        @media (max-width: 767.9px) {
            input.speech-input:focus {
                position: fixed;
                top: 25%;
                left: 50%;
                width: 100%;
                font-size: 3vw;
                line-height: 20vw;
                text-align: center;
                transform: translateX(-50%);
            }
            input.speech-input:placeholder-shown {
                font-size: 7vw;
            }
        }
        input.speech-input:focus::placeholder {
            color: var(--input-placeholder-color);
        }
        .players {
            border-radius: 30px;
            padding: 2.5em 0;
            min-width: 300px;
            max-width: 100%;
            box-sizing: border-box;
            background-image: var(--playerlist-bg-img), var(--playerlist-bg-img);
            background-size: cover, cover;
            background-blend-mode: darken, darken;
            background-position: top, bottom;
            box-shadow: var(--playerlist-shadow);
        }
        .round-counter {
            position: absolute;
            top: 20px;
            left: 40px;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #341603;
            /* font-weight: bold; */
            font-size: 12vw;
            font-family: 'East Sea Dokdo';
            line-height: 0.85;
        }
        .round-label {
            display: none;
            line-height: 0.75;
        }
        .round-tally {
            margin-left: 0.2em;
            width: 1em;
            height: 0.75em;
            background: transparent no-repeat center;
            background-size: contain;
            transform: skew(-5deg, 0deg);
            opacity: 1;
            filter: grayscale(1) brightness(0.75);
        }
        .round-tally[data-marks="1"] { background-image: url("images/tally-marks-1.png"); }
        .round-tally[data-marks="2"] { background-image: url("images/tally-marks-2.png"); }
        .round-tally[data-marks="3"] { background-image: url("images/tally-marks-3.png"); }
        .round-tally[data-marks="4"] { background-image: url("images/tally-marks-4.png"); }
        .round-tally[data-marks="5"] { background-image: url("images/tally-marks-5.png"); }
        #entries {
            display: none;
            flex: 1;
            margin: 0;
            padding: 20px 0;
            font-size: 5vw;
            list-style: none;
            overflow: auto;
        }
        @media (min-width: 592px) {
            .round-counter {
                font-size: 4.5rem;
            }
            #entries {
                font-size: 1.85rem;
            }
        }
        .players-listed #entries {
            display: flex;
            flex-flow: column;
        }
        #entries li {
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }
        #entries li span {
            flex: 1 1 auto;
            min-width: 2em;
            text-align: center;
        }
        #entries .highlighted .player-name {
            color: var(--highlighted-text-color);
        }
        #entries .player-order {
            flex: 0 0 1em;
            min-width: 1em;
            color: var(--main-text-color-alt);
        }
        .input-editable {
            margin: 0;
            outline: none !important;
            padding: 0 1.25em;
            border: none;
            border-radius: 15px;
            box-sizing: border-box;
            width: calc(100% - 4em);
            font-size: 0.5em;
            background: rgba(0,0,0,0.5);
            color: var(--main-text-color);
        }
        .input-editable.player-order {
            width: 5em;
            text-align: center;
        }
        #startButton {
            margin-top: 1.5em;
            padding: 0.4em 0.6em;
            -webkit-mask-size: contain;
            mask-size: contain;
        }
        .highlighted {
            position: relative;
        }
        .highlighted:before {
            content: "";
            position: absolute;
            top: 50%;
            left: 10%;
            display: block;
            border-radius: 15px;
            height: 0px;
            width: 80%;
            box-shadow: 0 0 20px 22px var(--highlighted-color);
        }
        button.previous-turn,
        button.advance-turn {
            margin: 0;
            padding: 0.4em 1.5em 0.25em;
            font-size: 1.5em;
        }
        .hide {
            display: none;
        }
        body:not(.active-turn) .active-turn-ui {
            display: none;
        }
        .active-turn .no-active-turn-ui {
            display: none;
        }
        body:not(.players-listed) .players-listed-ui {
            display: none;
        }

        /* Font handling */
        .font-baron-kuffner { font-family: "Baron Kuffner", sans-serif; } .font-broken-crush { font-family: "Broken Crush", sans-serif; } .font-creatinin-pro { font-family: "Creatinin-pro", sans-serif; } .font-inverted-interrobang { font-family: "Do You Want To Be My Inverted Interrobang", sans-serif; } .font-dracufrankenwolfbb { font-family: "Dracufrankenwolfbb", sans-serif; } .font-eordeoghlakat { font-family: "Eordeoghlakat", sans-serif; } .font-fibyngerowa { font-family: "Fibyngerowa", sans-serif; } .font-grenhil { font-family: "Grenhil", sans-serif; } .font-ickyticketmono { font-family: "Ickyticketmono", sans-serif; } .font-kgbythegraceofgod { font-family: "Kgbythegraceofgod", sans-serif; } .font-lincons { font-family: "Lincons", sans-serif; } .font-lugosi { font-family: "Lugosi", sans-serif; } .font-malinsha-rough { font-family: "Malinsha Rough", sans-serif; } .font-mystic-forest { font-family: "Mystic Forest", sans-serif; } .font-raventame { font-family: "Raventame", sans-serif; } .font-unionagrochem { font-family: "Unionagrochem", sans-serif; } .font-vtks-distress { font-family: "Vtks Distress", sans-serif; } .font-architects-daughter { font-family: 'Architects Daughter', cursive; } .font-babylonica { font-family: 'Babylonica', cursive; } .font-bilbo-swash-caps { font-family: 'Bilbo Swash Caps', cursive; } .font-caveat { font-family: 'Caveat', cursive; } .font-comforter { font-family: 'Comforter', cursive; } .font-condiment { font-family: 'Condiment', cursive; } .font-dawning-of-a-new-day { font-family: 'Dawning of a New Day', cursive; } .font-east-sea-dokdo { font-family: 'East Sea Dokdo', cursive; line-height: 0.85;} .font-fuggles { font-family: 'Fuggles', cursive; } .font-grape-nuts { font-family: 'Grape Nuts', cursive; } .font-homemade-apple { font-family: 'Homemade Apple', cursive; } .font-inspiration { font-family: 'Inspiration', cursive; } .font-julee { font-family: 'Julee', cursive; } .font-just-me-again-down-here { font-family: 'Just Me Again Down Here', cursive; } .font-kolker-brush { font-family: 'Kolker Brush', cursive; } .font-la-belle-aurore { font-family: 'La Belle Aurore', cursive; } .font-liu-jian-mao-cao { font-family: 'Liu Jian Mao Cao', cursive; } .font-long-cang { font-family: 'Long Cang', cursive; } .font-nanum-brush-script { font-family: 'Nanum Brush Script', cursive; } .font-nothing-you-could-do { font-family: 'Nothing You Could Do', cursive; } .font-oooh-baby { font-family: 'Oooh Baby', cursive; } .font-over-the-rainbow { font-family: 'Over the Rainbow', cursive; } .font-permanent-marker { font-family: 'Permanent Marker', cursive; } .font-qwitcher-grypen { font-family: 'Qwitcher Grypen', cursive; } .font-reenie-beanie { font-family: 'Reenie Beanie', cursive; } .font-rock-salt { font-family: 'Rock Salt', cursive; } .font-ruthie { font-family: 'Ruthie', cursive; } .font-sassy-frass { font-family: 'Sassy Frass', cursive; } .font-sedgwick-ave { font-family: 'Sedgwick Ave', cursive; } .font-shalimar { font-family: 'Shalimar', cursive; } .font-smooch { font-family: 'Smooch', cursive; } .font-splash { font-family: 'Splash', cursive; } .font-square-peg { font-family: 'Square Peg', cursive; } .font-swanky-and-moo-moo { font-family: 'Swanky and Moo Moo', cursive; } .font-vujahday-script { font-family: 'Vujahday Script', cursive; } .font-waiting-for-the-sunrise { font-family: 'Waiting for the Sunrise', cursive; } .font-walter-turncoat { font-family: 'Walter Turncoat', cursive; } .font-whisper { font-family: 'Whisper', cursive; }
</style>
</head>
<body class="">

    <div class="header-menu">
        <button id="settingsMenuBtn" class="toggle-settings-menu" onclick="toggleSettingsMenu()">
            <i class="fas fa-ellipsis no-back-ui"></i>
            <i class="fas fa-xmark back-ui"></i>
        </button>
    </div>

    <div class="settings-menu hide">
        <div class="settings-menu-group">
            <label>Brightness</label>
            <div class="settings-input">
                <div class="button-group button-group-number-bump">
                    <button id="decrBrightness" onclick="decreaseBrightness()">-</button>
                    <input id="brightness" class="input-number-bump" value="1" type="number" onchange="updateBrightnessLevel(this.value)"/>
                    <button id="incrBrightness" onclick="increaseBrightness()">+</button>
                </div>
            </div>
        </div>
        <div class="settings-menu-group">
            <label>Font</label>
            <div class="settings-input">
                <select id="selectFont"></select>
            </div>
        </div>
        <div class="settings-menu-group" style="display: none;">
            <label>Round Counter</label>
            <div class="settings-input">
                <input id="toggleRoundCounter" type="checkbox"/>
            </div>
        </div>
    </div>

    <p id="interimWords" style="display: none; color: white;"></p>
    <p id="eventlog" style="display: none; color: white;"></p>

    <div class="main">
        <button id="clearAll" class="clear-all players-listed-ui" onclick="confirm('Clear Everything?') ? clearAll() : null">✕</button>
        <form action="#" style="display:none;"><input id="testInput" type="text" placeholder="test input"/></form>
        <!--<div id="startDictation" class="gn" tabindex="0"><div class="mc"></div></div>-->
        <p class="pre-microphone-msg">Tap the mic to enable microphone on your device</p>
        <p class="post-microphone-msg">Hold the mic button and speak all initiative rolls. Ex: "Scanlan rolled 12"</p>
        <form id="speechForm" style="display:none;" action="">
            <input id="speechInput" class="speech-input" type="text" placeholder="⇣Dictate with voice key, then press ↵"/>
        </form>
        <div class="players players-listed-ui">
            <div id="roundCounter" class="round-counter">
                <span class="round-label"></span>
                <!-- will be populated dynamically with: <div class="round-tally" data-marks="0"></div> -->
            </div>
            <ul id="entries">
                <!-- will be populated dynamically -->
            </ul>
        </div>
        <div class="button-group">
            <button id="prevTurn" class="previous-turn active-turn-ui" onclick="goBackOneTurn()"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>
            <div id="startDictation">
                <i class="fa-solid fa-microphone"></i>
            </div>
            <button id="nextTurn" class="advance-turn active-turn-ui" onclick="advanceTurn()"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>
        </div>
        <button id="startButton" class="no-active-turn-ui players-listed-ui" onclick="startTurnCounter()">Start</button>
    </div>
    <script>
        let micAllowed = false
        let chosenFont
        let players = []
        let currentTurn = 0
        let currentRound = 1
        let final_transcript = ''
        let allTranscripts = []
        const numberMap = {
            'zero': 0,
            'one': 1, 'won': 1,
            'two': 2, 'to': 2, 'too': 2,
            'three': 3, 'tree': 3,
            'four': 4, 'fore': 4, 'for': 4, 'forth': 4, 'fourth': 4, '4th': 4,
            'five': 5, 'fi': 5, 'fife': 5,
            'six': 6, 'sex': 6, 'sixth': 6, '6th': 6,
            'seven': 7, '7th': 7,
            'eight': 8, 'ate': 8, 'eighth': 8, '8th': 8,
            'nine': 9, 'nigh': 9, 'ninth': 9, '9th': 9,
            'ten': 10, 'tin': 10, 'tenth': 10, '10th': 10,
            'eleven': 11, 'eleventh': 11, '11th': 11,
            'twelve': 12, 'twelveth': 12, '12th': 12,
            'thirteen': 13,'thirteenth': 13,'13th': 13,
            'fourteen': 14, 'fourteenth': 14, '14th': 14,
            'fifteen': 15, 'fifteenth': 15, '15th': 15,
            'sixteen': 16, 'sixteenth': 16, '16th': 16,
            'seventeen': 17, 'seventeenth': 17, '17th': 17,
            'eighteen': 18, 'eighteenth': 18, '18th': 18,
            'nineteen': 19, 'nineteenth': 19, '19th': 19,
            'twenty': 20, 'twentieth': 20,
            'twenty-one': 21, 'twenty-two': 22, 'twenty-three': 23,
            'twenty-four': 24, 'twenty-fourth': 24, 'twenty-five': 25,
            'twenty-six': 26, 'twenty-sixth': 26, '26th': 26,
            'twenty-seven': 27, 'twenty-seventh': 27, '27th': 27,
            'twenty-eight': 28, 'twenty-eighth': 28, '28th': 28,
            'twenty-nine': 29, 'twenty-ninth': 29, '29th': 29,
            'thirty': 30, 'thirtieth': 30, '30th': 30,
            'thirty-one': 31, 'thirty-two': 32
        }

        Element.prototype.onClassAdded = function(className, callback) {
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const oldClassList = mutation.oldValue ? mutation.oldValue.split(/\s+/) : []
                        const newClassList = this.className.split(/\s+/);
                        if (newClassList.includes(className) && !oldClassList.includes(className)) {
                            callback()
                        }
                    }
                });
            });
            observer.observe(this, { attributes: true, attributeOldValue: true, attributeFilter: ['class'] })
        };

        Element.prototype.onClassRemoved = function(className, callback) {
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const oldClassList = mutation.oldValue ? mutation.oldValue.split(/\s+/) : [];
                        const newClassList = this.className.split(/\s+/)
                        if (!newClassList.includes(className) && oldClassList.includes(className)) {
                            callback()
                        }
                    }
                });
            });
            observer.observe(this, { attributes: true, attributeOldValue: true, attributeFilter: ['class'] })
            // Usage
            // document.body.onClassAdded('active-turn', function() { /* do stuff */ });
            // document.body.onClassRemoved('active-turn', function() { /* do stuff */ });
        };

        window.onload = function() {
            /* Get font config from cookie */
            chosenFont = getCookie('fontPreference') || 'font-nothing-you-could-do'
            setCookie('fontPreference', chosenFont)
            document.body.classList.add(chosenFont)
            populateSelectWithFonts()
            document.querySelector('#selectFont').addEventListener('change', function(event) {
                const selectedClass = event.target.value
                // First, remove any existing font- class from the body
                Array.from(document.body.classList).forEach(className => className.startsWith('font-') && document.body.classList.remove(className))
                // Then, add the new selected class
                document.body.classList.add(selectedClass)
                // Remember the setting
                setCookie('fontPreference', selectedClass)
            })

            /* Get brightness conif from cookie */
            const cookieBrightness = getCookie('brightnessPreference') || 1
            document.getElementById('brightness').value = parseFloat(cookieBrightness);
            document.documentElement.style.setProperty('--brightness-level', parseFloat(cookieBrightness));

            // Recall player entries saved to cookie
            const savedEntries = getCookie('players')
            if (savedEntries) {
                players = JSON.parse(savedEntries)
                renderPlayers()
            }

            // Rehydrate the current turn, if it was recorded
            const turnStarted = getCookie('turnStarted')
            if (turnStarted) {
                document.body.classList.add('active-turn')
            }
            const savedRound = getCookie('round')
            if (savedRound) {
                currentRound = parseInt(savedRound, 10)

                // Rehydrate the tally marks on page refresh
                if (savedRound > 0) {
                    updateTally(savedRound)
                }
            }
            const savedTurn = getCookie('turn')
            if (savedTurn) {
                currentTurn = parseInt(savedTurn, 10)
                highlightCurrentTurn()
            }

            // Handle microphone permissions

            // Asynchronously check to see if the microphone permission has been granted during the session
            navigator.permissions.query({ name: 'microphone' }).then(function(permissionStatus) {
                if (micAllowed || players.length > 0) return // assume they know what they're doing
                if (permissionStatus.state !== 'granted') {
                    // Microphone permission is not yet granted
                    console.log('Microphone permission is not yet granted.')
                    document.querySelector('.pre-microphone-msg').classList.add('show')

                    // let interval

                    // Listen for changes to the permission state
                    permissionStatus.onchange = function() {
                        // alert(this.state + ' (onchange event)')
                        if(this.state === 'granted') {
                            console.log('Microphone permission was just granted')
                            micAllowed = true
                            document.querySelector('.pre-microphone-msg').classList.remove('show')
                            document.querySelector('.post-microphone-msg').classList.add('show')
                            // if (interval) clearInterval(interval)
                        }
                    }

                    function showFirstTimerMessageOnce () {
                        document.querySelector('.pre-microphone-msg').classList.remove('show')
                        document.querySelector('.post-microphone-msg').classList.add('show')
                        document.getElementById('startDictation').removeEventListener('touchstart', showFirstTimerMessageOnce)
                    }
                    document.getElementById('startDictation').addEventListener('touchstart', showFirstTimerMessageOnce)

                    // function keepCheckingForMicrophonePermission(e) {
                    //     e.preventDefault()

                    //     alert('touchstart')
                    //     if (!interval) {
                            
                    //         alert('!interval')
                    //         interval = setInterval(() => {
                    //             navigator.permissions.query({ name: 'microphone' }).then(permStatus => {
                    //                 alert(permStatus.state)
                    //                 if (permStatus.state === 'granted') {
                    //                     alert(permStatus.state + ' (setInterval)')
                    //                     console.log('Microphone permission was granted')
                    //                     micAllowed = true
                    //                     document.querySelector('.pre-microphone-msg').classList.remove('show')
                    //                     document.querySelector('.post-microphone-msg').classList.add('show')
                    //                     clearInterval(interval)
                    //                 }
                    //             })
                    //         }, 500) // Check every half-second after the mic button is tapped
                    //     }

                    //     // We only want to listen after the first mic tap, then unbind this listener.
                    //     document.getElementById('startDictation').removeEventListener('touchstart', keepCheckingForMicrophonePermission)
                    // }

                    // document.getElementById('startDictation').addEventListener('touchstart', keepCheckingForMicrophonePermission)

                } else {
                    micAllowed = true
                }
            })
            
            // set the state of the Previous buttton based on rehydrated round/turn state
            document.getElementById('prevTurn').disabled = (currentRound < 2 && currentTurn < 1)

            document.getElementById('startDictation').addEventListener('mousedown', function(e) {
                e.preventDefault()
                handleMicPress()
            })
            document.getElementById('startDictation').addEventListener('touchstart', function(e) {
                e.preventDefault()
                handleMicPress()
            })
            document.getElementById('startDictation').addEventListener('mouseup', function(e) {
                e.preventDefault()
                handleMicRelease()
            })
            document.getElementById('startDictation').addEventListener('touchend', function(e) {
                e.preventDefault()
                handleMicRelease()
            })


            // // SPEECH INPUT BUTTON HANDLING ==========================================

            // document.getElementById('speechInput').addEventListener('focus', function(e) {
            //     logEvent(e)
            //     this.select()
            // })
            // document.getElementById('speechInput').addEventListener('focusout', function(e) {
            //     logEvent(e)
            //     parseAndAddEntries()
            // })

            // // Submit handler
            // document.getElementById("speechForm").parentElement.addEventListener('submit', function(e) {
            //     e.preventDefault()
            //     logEvent(e)
            //     parseAndAddEntries()
            //     setTimeout(()=>{document.getElementById('startButton').focus()}, 1)
            // })

            const events = ['input', 'change', 'keydown', 'focus', 'focusin', 'focusout', 'blur', 'beforeinput', 'compositionstart', 'compositionupdate', 'compositionend', 'select', 'paste', 'copy', 'submit'];
            events.forEach(function(event) {
                document.getElementById("testInput").addEventListener(event, function(e) {
                    logEvent(e)
                })
            })

            function logEvent (e) {
                console.log(e.type)
                document.getElementById('eventlog').innerHTML += ('<br/>' + e.type + (e.type == 'keydown' ? ' '+e.which : ''))
            }

            document.body.onClassAdded('active-turn', function() {
                console.log('active-turn was added')
                document.getElementById('prevTurn').disabled = true
                document.getElementById('nextTurn').disabled = false
                document.getElementById('startButton').disabled = true
            })

            document.body.onClassRemoved('active-turn', function() {
                console.log('active-turn was removed')
                document.getElementById('prevTurn').disabled = true
                document.getElementById('nextTurn').disabled = true
                document.getElementById('startButton').disabled = false
            })
        };

        function toggleSettingsMenu() {
            const settingsMenuButton = document.getElementById('settingsMenuBtn');
            const settingsMenu = document.querySelector('.settings-menu');
            const mainAppBody = document.querySelector('.main');
            settingsMenuButton.classList.toggle('back');
            settingsMenu.classList.toggle('hide');
            mainAppBody.classList.toggle('hide');
        }

        function updateBrightnessLevel(value) {
            document.documentElement.style.setProperty('--brightness-level', parseFloat(value));
            setCookie('brightnessPreference', parseFloat(value))
        }

        function increaseBrightness() {
            var brightnessInput = document.getElementById('brightness');
            const currentValue = parseFloat(brightnessInput.value);
            if (currentValue < 3) {
                brightnessInput.value = parseFloat(brightnessInput.value) + 0.25;
                brightnessInput.dispatchEvent(new Event('change'));
            }
        }

        function decreaseBrightness() {
            var brightnessInput = document.getElementById('brightness');
            const currentValue = parseFloat(brightnessInput.value);
            if (currentValue > 0.25) {
                   brightnessInput.value = currentValue - 0.25;
                brightnessInput.dispatchEvent(new Event('change'));
            }
        }

        function populateSelectWithFonts() {
            const fonts = [
                'Architects Daughter', 'Babylonica', 'Baron Kuffner', 'Bilbo Swash Caps', 'Broken Crush', 'Caveat', 'Comforter', 'Condiment',
                'Creatinin-pro', 'Dawning of a New Day', 'Dracufrankenwolfbb', 'East Sea Dokdo','Eordeoghlakat', 'Fibyngerowa', 'Fuggles',
                'Grape Nuts', 'Grenhil', 'Homemade Apple', 'Ickyticketmono', 'Inspiration', 'Inverted Interrobang', 'Julee', 'Just Me Again Down Here',
                'Kgbythegraceofgod', 'Kolker Brush', 'La Belle Aurore', 'Lincons', 'Liu Jian Mao Cao', 'Long Cang','Lugosi', 'Malinsha Rough', 'Mystic Forest',
                'Nanum Brush Script', 'Nothing You Could Do', 'Oooh Baby', 'Over the Rainbow','Permanent Marker', 'Qwitcher Grypen', 'Raventame',
                'Reenie Beanie', 'Rock Salt', 'Ruthie', 'Sassy Frass', 'Sedgwick Ave', 'Shalimar','Smooch', 'Splash', 'Square Peg', 'Swanky and Moo Moo',
                'Unionagrochem', 'Vtks Distress', 'Vujahday Script', 'Waiting for the Sunrise', 'Walter Turncoat', 'Whisper'
            ]

            const selectElement = document.querySelector('#selectFont')
            fonts.forEach(font => {
                const option = document.createElement('option')
                const val = 'font-' + font.toLowerCase().replace(/\s+/g, '-') // Convert font name to classname format
                option.value = val
                if (val == chosenFont) {
                    option.selected = true
                }
                option.textContent = font
                selectElement.appendChild(option)
            })
        }

        function parseAndAddEntries() {

            const joinedInput = allTranscripts.join(' ')
            let convertedInput = processInput(joinedInput, numberMap)

            const regex = /([\w\s]+?)\s*?@ (-?\d+)/g
            let matches

            players = []
            while ((matches = regex.exec(convertedInput)) !== null) {
                let name = matches[1].trim()
                let orderString = matches[2]

                let order
                if (orderString && isNaN(orderString)) {
                    order = numberMap[orderString.toLowerCase()] || NaN
                } else if(orderString && !isNaN(orderString)) {
                    order = parseInt(orderString, 10)
                } else {
                    order = NaN  // default to NaN if orderString is not defined
                }

                // Remove leading "and ", then capitalize the names
                name = name.replace(/^and /, '').split(" ").map(capitalize).join(" ")
                players.push({ name: name, order: order })
            }

            // Sorting and rendering the players
            players.sort((a, b) => b.order - a.order)
            renderPlayers()
            setCookie('players', JSON.stringify(players))
        }

        function processInput(input, numberMap) {
            console.log('Before processing: '+input)

            // Remove punctuation
            input = input.replace(/[.,!?;:()]/g, '').toLowerCase()

            // Add a space to the end
            input = input + ' '

            // Replace the roll/role variations with the symbol "@"
            input = input.replace(/ (rolled|rolls|roll|roles|role|roads|road|rd|ruled|rules|rule|world|whirled|whirl|wrote|rote)( a| an| and| of| on| ah)? /g, ' @ ')
            
            // Handle negative numbers in word format adjacent to "@"
            const negativeWordPattern = /@ (?:negative|-) (\w+|\d+)/g
            input = input.replace(negativeWordPattern, (match, wordOrNum) => {
                if (numberMap[wordOrNum]) {
                    return '@ -' + numberMap[wordOrNum]
                } else {
                    return '@ -' + wordOrNum
                }
            })
            
            // Handle negative numbers in digit format after "@"
            const negativePatternAfter = /@ negative (\d+)/g
            input = input.replace(negativePatternAfter, (match, p1) => {
                return '@ -' + p1
            })

            // Handle hyphenated numbers adjacent to "rolled" 
            for (const [word, number] of Object.entries(numberMap)) {
                if (!word.includes('-')) continue

                let patternBefore = new RegExp(`\\b${word}(?= @)`, 'g')
                let patternAfter = new RegExp(`(?<=@ )${word}(?= )`, 'g')
                let patternAfterA = new RegExp(`(?<=@ a )${word}\\b`, 'g')
                let patternAfterAn = new RegExp(`(?<=@ an )${word}\\b`, 'g')
                let patternAfterAnd = new RegExp(`(?<=@ and )${word}\\b`, 'g')

                input = input.replace(patternBefore, `${number}`)
                input = input.replace(patternAfter, `${number}`)
                input = input.replace(patternAfterA, `${number}`)
                input = input.replace(patternAfterAn, `${number}`)
                input = input.replace(patternAfterAnd, `${number}`)
            }

            // Then handle non-hyphenated numbers adjacent to "rolled"
            for (const [word, number] of Object.entries(numberMap)) {
                if (word.includes('-')) continue

                let patternBefore = new RegExp(`\\b${word}(?= @)`, 'g')
                let patternAfter = new RegExp(`(?<=@ )${word}(?= )`, 'g')
                let patternAfterA = new RegExp(`(?<=@ a )${word}\\b`, 'g')
                let patternAfterAn = new RegExp(`(?<=@ an )${word}\\b`, 'g')
                let patternAfterAnd = new RegExp(`(?<=@ and )${word}\\b`, 'g')

                input = input.replace(patternBefore, `${number}`)
                input = input.replace(patternAfter, `${number}`)
                input = input.replace(patternAfterA, `${number}`)
                input = input.replace(patternAfterAn, `${number}`)
                input = input.replace(patternAfterAnd, `${number}`)
            }

            console.log('After processing: '+input)

            return input
        }

        function capitalize(word) {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        }

        function startTurnCounter() {
            highlightCurrentTurn()
            document.body.classList.add('active-turn')
            updateTally(currentRound)
            setCookie('round', currentRound)
            setCookie('turnStarted', 'true')
        }

        function advanceTurn() {
            currentTurn = (currentTurn + 1) % players.length
            setCookie('turn', currentTurn)

            // Start a new round if it wraps back to the first player
            if (currentTurn == 0) {
                currentRound++
                updateTally(currentRound)
                setCookie('round', currentRound)
            }
            
            highlightCurrentTurn()

            document.getElementById('prevTurn').disabled = false
        }

        function goBackOneTurn() {
            currentTurn--
            
            // If it wraps back to the last player
            if (currentTurn == -1) {
                currentTurn = players.length-1
                currentRound--

                // Reset if we went back to "round 0"
                if (currentRound == 0) {
                    currentRound = 1
                    currentTurn = 0
                    turnStarted = false
                    setCookie('turnStarted', 'false')

                }
                updateTally(currentRound)
                setCookie('round', currentRound)
            }

            highlightCurrentTurn()
            setCookie('turn', currentTurn)

            if (currentRound == 1 && currentTurn == 0) {
                document.getElementById('prevTurn').disabled = true
            }
        }

        // Update the round counter tally marks
        function updateTally(roundNumber) {
            const roundCounter = document.getElementById('roundCounter')
            let existingTallies = roundCounter.querySelectorAll('.round-tally')
            
            let requiredTallies = Math.ceil(roundNumber / 5)
            let difference = requiredTallies - existingTallies.length

            // In round 1, use the label "Round ", then remove it for round 2+
            roundCounter.querySelector('.round-label').textContent = (roundNumber == 1 ? 'Round ' : '');
            // Add required tally elements if they're less than needed
            for (let i = 0; i < difference; i++) {
                const element = document.createElement('div')
                element.classList.add('round-tally')
                roundCounter.appendChild(element)
            }

            // Remove extra tally elements if they're more than needed
            for (let i = 0; i < -difference; i++) {
                roundCounter.removeChild(existingTallies[existingTallies.length - 1]);
            }

            // Update the data-marks attribute for all tally elements
            existingTallies = roundCounter.querySelectorAll('.round-tally');  // fetch the tallies again after potential changes
            for (let i = 0; i < existingTallies.length; i++) {
                const marks = (i === existingTallies.length - 1) ? (roundNumber % 5 === 0 ? 5 : roundNumber % 5) : 5
                existingTallies[i].setAttribute('data-marks', marks.toString())
            }
        }

        function clearAll() {
            players = []
            currentTurn = 0
            currentRound = 1
            renderPlayers()
            final_transcript = ''
            allTranscripts = []
            document.body.classList.remove('active-turn')
            document.body.classList.remove('players-listed')
            document.getElementById('speechInput').value = ''
            document.getElementById('eventlog').textContent = ''
            document.querySelectorAll('.round-tally').forEach(el => el.remove());

            // Clearing cookies
            document.cookie = "players=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"
            document.cookie = "turn=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"
            document.cookie = "round=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"
            document.cookie = "turnStarted=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"
            document.cookie = "fontPreference=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"
        }

        function renderPlayers() {
            const list = document.getElementById('entries')
            list.innerHTML = ''
            for (let entry of players) {
                const li = document.createElement('li')
                
                const nameSpan = document.createElement('span')
                nameSpan.className = 'player-name'
                nameSpan.setAttribute('tabindex', '0')
                nameSpan.textContent = entry.name
                nameSpan.onclick = function() {
                    makeEditable(nameSpan, entry, 'name', 'text')
                }
                nameSpan.onfocus = function() {
                    makeEditable(nameSpan, entry, 'name', 'text')
                }
                
                const orderSpan = document.createElement('span')
                orderSpan.textContent = `${entry.order}`
                orderSpan.className = 'player-order'
                orderSpan.setAttribute('tabindex', '0')
                orderSpan.onfocus = function() {
                    makeEditable(orderSpan, entry, 'order', 'number')
                }
                orderSpan.onclick = function() {
                    makeEditable(orderSpan, entry, 'order', 'number')
                }
                
                li.appendChild(nameSpan)
                li.appendChild(orderSpan)
                list.appendChild(li)
            }
            document.body.classList.add('players-listed')
        }


        function makeEditable(element, entry, field, type) {
            const input = document.createElement('input')
            input.classList = element.classList
            input.classList.add('input-editable')
            input.type = type
            if (type == 'number') {
                input.setAttribute("pattern", "[0-9]*")
            } else {
                input.setAttribute("autocapitalize", "words")
            }
            input.value = entry[field]
            
            // Handle "submit" when Enter key is pressed
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    handleEdit()
                }
            })

            // Handle "submit" when input loses focus
            input.addEventListener('focusout', handleEdit)

            function handleEdit() {
                entry[field] = field === 'order' ? parseInt(input.value, 10) : input.value
                players.sort((a, b) => b.order - a.order) // Re-sorting on edit
                renderPlayers()
                setCookie('players', JSON.stringify(players))
            }

            element.replaceWith(input)
            input.select()
        }

        function highlightCurrentTurn() {
            const listItems = document.querySelectorAll('#entries li')
            listItems.forEach(li => li.classList.remove('highlighted'))
            if (listItems[currentTurn]) {
                listItems[currentTurn].classList.add('highlighted')
            }
        }

        function setCookie(name, value) {
            document.cookie = `${name}=${value};path=/`
        }

        function getCookie(name) {
            const value = "; " + document.cookie
            const parts = value.split("; " + name + "=")
            if (parts.length == 2) return parts.pop().split(";").shift()
        }

        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
        var recognition = new SpeechRecognition()

        // SPEECH API GRAMMER LIST ISN'T SUPPORTED IN CHROME... I GUESS?
        // // Speech Recognition!
        // var SpeechGrammarList = SpeechGrammarList || window.webkitSpeechGrammarList;
                    
        // // Fetch the grammar words from a local file
        // fetch('/spellcheck/monster-names.txt')
        //     .then(response => response.text())
        //     .then(text => {
        //         var words = text.split('\n') // Assuming words are separated by newlines
        
        //         if (SpeechGrammarList) {
        //             var speechRecognitionList = new SpeechGrammarList()
        //             var grammar = '#JSGF V1.0; grammar words; public <word> = ' + words.join(' | ') + ' ;'
        //             speechRecognitionList.addFromString(grammar, 1)
        //             recognition.grammars = speechRecognitionList
        //         }
        //     })
        //     .catch(error => {
        //         console.error("Error fetching the grammar words:", error)
        //     })

        recognition.continuous = true
        recognition.lang = 'en-US'
        recognition.interimResults = true
        recognition.maxAlternatives = 3

        let isListening = false
        var interimOutput = document.getElementById('interimWords')
        var finalOutput = document.getElementById('eventlog')
        let pauseTimer = null // Initialize the pause timer variable
        const PAUSE_THRESHOLD = 150 // Adjust this value to set the threshold for pauses (e.g., 1000ms or 1 second)
        let speechProcessedEvent = new Event('speechprocessed')
 
        recognition.onstart = function(event) {
            console.log('Speech started.')
            isListening = true
            final_transcript = ''
            finalOutput.innerHTML = final_transcript
            document.getElementById('speechInput').value = final_transcript
        }

        recognition.onresult = function(event) {
            let interim_transcript = ''
            micAllowed = true // if we got this far, mic is obv allowed

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    const spokenWords = event.results[i][0].transcript
                    final_transcript += spokenWords
                    console.log('final: '+spokenWords)
                    interim_transcript = ''
                } else {
                    interim_transcript += event.results[i][0].transcript
                }
                console.log('Confidence: ' + event.results[i][0].confidence)
            }

            interimOutput.innerHTML = interim_transcript
            document.querySelector('.post-microphone-msg').classList.remove('show')
            console.log(event.results)
        }
        
        recognition.onnomatch = function(event) {
            const huh = ['[incoherent]', '???', '[mumbling]', '[drunken slurring]', '[something something...]'][Math.floor(Math.random()*5)];
            interimOutput.textContent = huh
            console.warn(huh)
            console.log(event)
        }
        
        recognition.onerror = function(event) {
            interimOutput.textContent = 'Error occurred in recognition: ' + event.error
            console.error(event)
        }

        recognition.onend = function(event) {
            isListening = false
            console.warn('Speech ended. Parsing results.')
            if (isEmpty(final_transcript)) {
                if (micAllowed && players.length === 0) document.querySelector('.post-microphone-msg').classList.add('show')
                return
            }
            if (isClearCommand(final_transcript)) {
                clearAll()
                return
            }
            finalOutput.innerHTML = final_transcript
            // document.getElementById('speechInput').value = final_transcript
            allTranscripts.push(final_transcript)
            parseAndAddEntries(final_transcript)
            document.dispatchEvent(speechProcessedEvent)
        }

        function isEmpty(str) {
            // Test whether the user said (and said only) "clear", "cancel", or "start over".
            return str.trim() == ''
        }

        function isClearCommand(str) {
            // Test whether the user said (and said only) "clear", "cancel", or "start over".
            return /^(clear|cancel|start over)$/i.test(str.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").trim())
        }
        
        function handleMicPress() {
            let speechProcessedHandler = function() {
                recognition.start()
            }
            if (isListening) {
                // Wait until the previous speech recognition proccess finishes before trying to start a new one.
                document.addEventListener('speechprocessed', speechProcessedHandler)
                // Remove the speechprocessed event listener if the user releases the mic button early.
                document.getElementById('startDictation').addEventListener('mouseup', function() {
                    document.removeEventListener('speechprocessed', speechProcessedHandler)
                })
                document.getElementById('startDictation').addEventListener('touchend', function() {
                    document.removeEventListener('speechprocessed', speechProcessedHandler)
                })
            } else {
                recognition.start()
            }
        }

        function handleMicRelease() {
            recognition.stop()
            console.log('Mic button released.')
        }
        
    </script>
    <!--
        BUGS
        1. Sometimes when starting combat, the first tally mark doesn't show up.  Test this first.
        2. Previous prompts array should be saved to a cookie, so it can be reused after a page refresh if needed.

        TODOs
        0. Fix the bottom of the slate tablet so it shows the actual bottom edge if the div is tall enough, somehow.
        1. Fix Speech API parsing - parse times and 3+ digit numbers correctly. Ex: "3:15" or "124"
        2. If the parser doesn't detect any player entries from the input string, then do not go into "players-listed" mode.
        3. Refactor prompt storage - do not aggregate all prompt strings to reprocess on subsequent prompts. instead, weave into existing players list. MUST HAVE for #4 and #5 below.
        4. Allow ability to manually remove a player.  on <li> hover: an X icon shows.  on swipe left, an X field slides in; player is removed on further swipe or X click.
        5. Add ability to manually add a player to the list manual (voice entry already works)
        6. Save the previous 'speechInput values somewhere in a class="speech-input" hidden input or div. maybe remove portions of the string that didn't parse into entries. (might require a rework of the whole parsing system though, like splitting everything by ' ' and then manipulating a big ol array.)
        7. Add other commands to the dicatation input - make subsequent dictations (or "prompts") add more players to the list, instead of replacing. But clear the 'speechInput' field
        8. Handle spelled-out words, so they show without all-caps or spaces between letters.
        9. Implement a fancy styled dialog instead of window.confirm() on clearAll button press.
    -->
</body>
</html>
