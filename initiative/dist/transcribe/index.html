<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenAI API Example</title>
    <style>
        .main {
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .mic-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0.1em;
            width: 2em;
            height: 2em;
            font-size: 6.7rem;
            background-color: #358;
            color: white;
            border-radius: 50%;
            border-width: 0;
            outline: none;
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
            transition: background-color 0.2s;
        }
        .mic-btn:hover {
            background-color: #57a;
        }
        .mic-btn:active,
        .mic-btn.listening {
            background-color: #c24;
        }
        .mic-btn svg {
            width: 1em;
        }
        .results {
            margin: 1em 0 0;
            font-size: 2em;
            font-style: italic;
            color: #999;
            text-align: center;
        }
        .test-btn {
            margin: 1em;
        }
    </style>
    <script>
        let mediaRecorder;
        let audioChunks = [];

        function micBtnHandler(e) {
            const button = e.target.closest('button');
            if (!button) return;
            button.classList.toggle('listening')
            if (button.classList.contains('listening')) {
                startRecording()
            } else {
                stopRecording()
            }
        }

        function testBtnHandler(e) {
            const button = e.target.closest('button');
            if (!button) return;
            test()
        }

        async function startRecording() {
            audioChunks = []; // Clear previous recordings
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.start();
        }

        function stopRecording() {
            mediaRecorder.stop();
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = document.getElementById('audioPlayback');
                audio.src = audioUrl;

                const endpointUrl = 'https://ghseg8im58.execute-api.us-east-2.amazonaws.com/default/opanAiTranscribeTestPython';
                const prompt = "Leonarus: 20, Ogden: 18, Brogoth: 16, Thorn: 14, Anya: 12, Himmic: 10, Creature 1: 8, Creature 2: -1";
                const urlWithParams = `${endpointUrl}?prompt=${encodeURIComponent(prompt)}`;

                fetch(urlWithParams, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'audio/webm', // Set the correct content type
                    },
                    body: audioBlob // Send the audioBlob directly
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Results from openai: ${data}`);
                    let results = data.text;
                    results = reformatInitiativeOrderSyntax(results);
                    console.log(`Results after reformatting...`);
                    console.log(results);
                    const rows = results.map(entry => `<tr><td class="order">${entry.order}</td><td class="name">${entry.name}</td></tr>`).join('');
                    const tableHTML = `
                    <table class="initiative-order">
                        <thead>
                            <tr><th class="order">Order</th><th class="name">Name</th></tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    `;
                    document.getElementById('results').innerHTML = tableHTML;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            };
        }

        function test() {
            results = reformatInitiativeOrderSyntax("Dragon. 13, goblin negative 1. test 1, test, 20, goblin 1-9. Goblin 2-13, dragonborn 4 monster, 1, 15. monster 2, 11.")
            console.log(`Results after reformatting: "Dragon. 13, goblin negative 1. test 1, test, 20, goblin 1-9. Goblin 2-13, dragonborn 4 monster, 1, 15. monster 2, 11."`)
            console.log(results);
            const rows = results.map(entry => `<tr><td class="order">${entry.order}</td><td class="name">${entry.name}</td></tr>`).join('');
            const tableHTML = `
            <table class="initiative-order">
                <thead>
                    <tr><th class="order">Order</th><th class="name">Name</th></tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
            `;
            document.getElementById('results').innerHTML = tableHTML;
        }

        function reformatInitiativeOrderSyntax(input) {
            
            // Step 1: Remove any commas, periods, other punctuation
            input = input.replace(/[,\.:;/~]\s*/g, ' ');

            // Step 2: Replace "negative X" with "-X"
            input = input.replace(/negative (\d)/g, '-$1');

            // Step 3: Handle hyphen-separated numbers like "Thing 1-9"
            input = input.replace(/([a-z]+)\s+(\d+)-(\d+)/gi, '$1 $2 $3');

            // Step 4: Add a line break before names followed by numbers or just before numbers that should belong to the previous word
            input = input.replace(/([a-z]+)(?:( \d+))?\s+(-?\d+)/gi, '$1$2 @ $3, ');

            // Step 6: Capitalize the first letter of each line and convert to an array
            const array = input.split(', ').map(line => capitalize(line.trim()));

            // Step 7: Convert to objects and sort the array by rolled number value
            const sortedArray = array.map(item => {
                if (!item.includes('@')) {
                    return null;
                }
                let [name, order] = item.split('@').map(part => part.trim());
                return { name, order: parseFloat(order) };
            }).filter(item => item !== null).sort((a, b) => b.order - a.order);

            return sortedArray;
        }

        // Function to capitalize the first letter of a word
        function capitalize(word) {
            return word.charAt(0).toUpperCase() + word.slice(1);
        }
    </script>
</head>
<body>
    <div class="main">
        <h1>OpenAI API Example</h1>
        <button id="start-recognition" class="mic-btn" onclick="micBtnHandler(event)">
            <svg id="microphone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="white" d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/></svg>
        </button>
        <audio id="audioPlayback" controls></audio>
        <button id="parseTest" class="test-btn" onclick="testBtnHandler(event)">TEST</button>
        <p class="results" id="results"></p>
    </div>
</body>
</html>
