<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turn Counter</title>
    <style>
        .highlighted {
            background-color: yellow;
        }
        #entries li {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <p>Dragon rolled a 19 cultist one rolled and to cultist two rolled 20 Kalar is rolled three anya rolled one whiskers roll an 15 thorn role a negative 11</p>
    <div>
        <input type="text" id="speechInput" placeholder="Use speech-to-text">
        <button onclick="parseAndAddEntries()">Parse</button>
    </div>
    <ul id="entries"></ul>
    <button id="goButton" onclick="startTurnCounter()">Go</button>

    <button id="clearAllButton" onclick="clearAll()">Clear All</button>
    <script>
        let entries = [];
        let currentTurn = 0;
        let currentRound = 1;
        const numberMap = {
            'zero': 0,
            'one': 1, 'won': 1,
            'two': 2, 'to': 2, 'too': 2,
            'three': 3, 'tree': 3,
            'four': 4, 'fore': 4, 'for': 4,
            'five': 5,
            'six': 6, 'sex': 6,
            'seven': 7,
            'eight': 8, 'ate': 8,
            'nine': 9, 'nigh': 9,
            'ten': 10, 'tin': 10,
            'eleven': 11,
            'twelve': 12,
            'thirteen': 13,
            'fourteen': 14,
            'fifteen': 15,
            'sixteen': 16,
            'seventeen': 17,
            'eighteen': 18,
            'nineteen': 19,
            'twenty': 20,
            'twenty-one': 21, 'twenty-two': 22, 'twenty-three': 23,
            'twenty-four': 24, 'twenty-five': 25, 'twenty-six': 26,
            'twenty-seven': 27, 'twenty-eight': 28, 'twenty-nine': 29,
            'thirty': 30, 'thirty-one': 31, 'thirty-two': 32
        };

        window.onload = function() {
            const savedEntries = getCookie('entries');
            if (savedEntries) {
                entries = JSON.parse(savedEntries);
                renderEntries();
            }

            // rehydrate the current turn, if it was recorded
            const turnStarted = getCookie('turnStarted');
            if (turnStarted) {
                if (document.getElementById('goButton')) {
                    document.getElementById('goButton').remove();
                }
            }
            const savedRound = getCookie('round');
            if (savedRound) {
                currentRound = parseInt(savedRound, 10);
                document.getElementById('roundCounter').textContent = 'Round ' + savedRound;
            }
            const savedTurn = getCookie('turn');
            if (savedTurn) {
                currentTurn = parseInt(savedTurn, 10);
                highlightCurrentTurn();
            }
            
            if (document.getElementById('previousTurn')) document.getElementById('previousTurn').disabled = (currentRound < 2 && currentTurn < 1);

            document.getElementById('speechInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    parseAndAddEntries();
                }
            });

            document.getElementById('speechInput').addEventListener('focus', function() {
                this.select();
            });
        };

        function parseAndAddEntries() {
            const input = document.getElementById('speechInput').value + " ";
            let convertedInput = processInput(input, numberMap);

            const regex = /([\w\s]+?)\s*?@ (-?\d+)/g;
            let matches;

            while ((matches = regex.exec(convertedInput)) !== null) {
                let name = matches[1].trim();
                let orderString = matches[2];

                let order;
                if (orderString && isNaN(orderString)) {
                    order = numberMap[orderString.toLowerCase()] || NaN;
                } else if(orderString && !isNaN(orderString)) {
                    order = parseInt(orderString, 10);
                } else {
                    order = NaN;  // default to NaN if orderString is not defined
                }

                // Capitalize the name
                name = name.split(" ").map(capitalize).join(" ");
                entries.push({ name: name, order: order });
            }

            // Sorting and rendering the entries
            entries.sort((a, b) => b.order - a.order);
            renderEntries();
            setCookie('entries', JSON.stringify(entries));
        }

        function processInput(input, numberMap) {
            console.log(input);

            // Remove punctuation
            input = input.replace(/[.,!?;:()]/g, '');

            // Replace the roll/role variations with the symbol "@"
            input = input.replace(/ (rolled|roll|role)( a| an| and)? /g, ' @ ');
            console.log(input);

            // Handle negative numbers in word format adjacent to "@"
            const negativeWordPattern = /@ (?:negative|-) (\w+|\d+)/g;
            input = input.replace(negativeWordPattern, (match, wordOrNum) => {
                if (numberMap[wordOrNum]) {
                    return '@ -' + numberMap[wordOrNum];
                } else {
                    return '@ -' + wordOrNum;
                }
            });
            console.log(input);
            
            // Handle negative numbers in digit format after "@"
            const negativePatternAfter = /@ negative (\d+)/g;
            input = input.replace(negativePatternAfter, (match, p1) => {
                return '@ -' + p1;
            });
            console.log(input);

            // Handle hyphenated numbers adjacent to "rolled" 
            for (const [word, number] of Object.entries(numberMap)) {
                if (!word.includes('-')) continue;

                let patternBefore = new RegExp(`\\b${word}(?= @)`, 'g');
                let patternAfter = new RegExp(`(?<=@ )${word}(?= )`, 'g');
                let patternAfterA = new RegExp(`(?<=@ a )${word}\\b`, 'g');
                let patternAfterAn = new RegExp(`(?<=@ an )${word}\\b`, 'g');
                let patternAfterAnd = new RegExp(`(?<=@ and )${word}\\b`, 'g');

                input = input.replace(patternBefore, `${number}`);
                input = input.replace(patternAfter, `${number}`);
                input = input.replace(patternAfterA, `${number}`);
                input = input.replace(patternAfterAn, `${number}`);
                input = input.replace(patternAfterAnd, `${number}`);
            }
            console.log(input);

            // Then handle non-hyphenated numbers adjacent to "rolled"
            for (const [word, number] of Object.entries(numberMap)) {
                if (word.includes('-')) continue;

                let patternBefore = new RegExp(`\\b${word}(?= @)`, 'g');
                let patternAfter = new RegExp(`(?<=@ )${word}(?= )`, 'g');
                let patternAfterA = new RegExp(`(?<=@ a )${word}\\b`, 'g');
                let patternAfterAn = new RegExp(`(?<=@ an )${word}\\b`, 'g');
                let patternAfterAnd = new RegExp(`(?<=@ and )${word}\\b`, 'g');

                input = input.replace(patternBefore, `${number}`);
                input = input.replace(patternAfter, `${number}`);
                input = input.replace(patternAfterA, `${number}`);
                input = input.replace(patternAfterAn, `${number}`);
                input = input.replace(patternAfterAnd, `${number}`);
            }
            console.log(input);

            return input;
        }

        function capitalize(word) {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }

        function startTurnCounter() {
            highlightCurrentTurn();
            if (document.getElementById('goButton')) {
                document.getElementById('goButton').disabled = true;
            }
            setCookie('turnStarted', 'true');
        }

        function advanceTurn() {
            currentTurn = (currentTurn + 1) % entries.length;
            setCookie('turn', currentTurn);

            // If it wraps back to the first player
            if (currentTurn == 0) {
                currentRound++;
                document.getElementById('roundCounter').textContent = 'Round ' + currentRound;
                setCookie('round', currentRound);
            }
            
            highlightCurrentTurn();

            if (document.getElementById('previousTurn')) {
                document.getElementById('previousTurn').disabled = false;
            }
        }

        function goBackOneTurn() {
            // currentTurn = (currentTurn - 1 + entries.length) % entries.length;
            currentTurn--
            
            // If it wraps back to the last player
            if (currentTurn == -1) {
                currentTurn = entries.length-1
                currentRound--

                // Reset if we went back to "round 0"
                if (currentRound == 0) {
                    currentRound = 1;
                    currentTurn = 0;
                    turnStarted = false;
                    setCookie('turnStarted', 'false');

                }
                document.getElementById('roundCounter').textContent = 'Round ' + currentRound;
                setCookie('round', currentRound)
            }

            highlightCurrentTurn();
            setCookie('turn', currentTurn);

            if (currentRound == 1 && currentTurn == 0) {
                document.getElementById('previousTurn').disabled = true;
            }
        }

        function clearAll() {
            entries = [];
            currentTurn = 0;
            currentRound = 1;
            renderEntries();
            if (document.getElementById('roundCounter')) document.getElementById('roundCounter').remove();
            if (document.getElementById('previousTurn')) document.getElementById('previousTurn').remove();
            if (document.getElementById('nextTurn')) document.getElementById('nextTurn').remove();
            if (document.getElementById('goButton')) document.getElementById('goButton').remove();

            // Clearing cookies
            document.cookie = "entries=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = "turn=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = "round=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = "turnStarted=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        }

        function renderEntries() {
            const list = document.getElementById('entries');
            list.innerHTML = '';
            for (let entry of entries) {
                const li = document.createElement('li');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = entry.name;
                nameSpan.onclick = function() {
                    makeEditable(nameSpan, entry, 'name');
                };
                
                const orderSpan = document.createElement('span');
                orderSpan.textContent = `(${entry.order})`;
                orderSpan.onclick = function() {
                    makeEditable(orderSpan, entry, 'order');
                };
                
                li.appendChild(nameSpan);
                li.appendChild(orderSpan);
                list.appendChild(li);
            }
            const roundCounter = document.createElement('h2');
            roundCounter.setAttribute('id', 'roundCounter');
            roundCounter.classList = 'round-counter';
            roundCounter.textContent = 'Round 1';
            list.prepend(roundCounter);
            const prevButton = document.createElement('button');
            prevButton.setAttribute('id', 'previousTurn');
            prevButton.classList = 'previous-turn';
            prevButton.textContent = 'Previous Turn';
            prevButton.onclick = goBackOneTurn;
            list.appendChild(prevButton);
            const advanceButton = document.createElement('button');
            advanceButton.setAttribute('id', 'nextTurn');
            advanceButton.classList = 'advance-turn';
            advanceButton.textContent = 'Advance Turn';
            advanceButton.onclick = advanceTurn;
            list.appendChild(advanceButton);
        }


        function makeEditable(element, entry, field) {
            const input = document.createElement('input');
            input.value = entry[field];
            
            // Handle "submit" when Enter key is pressed
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    handleEdit();
                }
            });

            // Handle "submit" when input loses focus
            input.addEventListener('focusout', handleEdit);

            function handleEdit() {
                entry[field] = field === 'order' ? parseInt(input.value, 10) : input.value;
                entries.sort((a, b) => b.order - a.order); // Re-sorting on edit
                renderEntries();
                setCookie('entries', JSON.stringify(entries));
            }

            element.replaceWith(input);
            input.select(); 
        }

        function highlightCurrentTurn() {
            const listItems = document.querySelectorAll('#entries li');
            listItems.forEach(li => li.classList.remove('highlighted'));
            if (listItems[currentTurn]) {
                listItems[currentTurn].classList.add('highlighted');
            }
        }

        function setCookie(name, value) {
            document.cookie = `${name}=${value};path=/`;
        }

        function getCookie(name) {
            const value = "; " + document.cookie;
            const parts = value.split("; " + name + "=");
            if (parts.length == 2) return parts.pop().split(";").shift();
        }
    </script>
</body>
</html>
